# =============================================================================
# Gomu News Monitor - GitHub Actions Workflow
# =============================================================================
#
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” GitHubì˜ ë¬´ë£Œ í´ë¼ìš°ë“œ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
# - ë¹„ìš©: $0 (public repository)
# - PC ë„ê¸°: ê°€ëŠ¥ (í´ë¼ìš°ë“œì—ì„œ ì‹¤í–‰)
# - ìŠ¤ì¼€ì¤„: ë§¤ì¼ ì˜¤ì „ 7ì‹œ 50ë¶„ (KST) ìë™ ì²´í¬
#
# =============================================================================

name: Gomu News Monitor

on:
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰: ë§¤ì¼ 1íšŒ (UTC ê¸°ì¤€)
  # UTC ì‹œê°„ì´ë¯€ë¡œ í•œêµ­ì‹œê°„(KST)ê³¼ 9ì‹œê°„ ì°¨ì´ê°€ ìˆìŠµë‹ˆë‹¤
  # KST 07:50 = UTC 22:50 (ì „ë‚ )
  schedule:
    - cron: '50 22 * * *'  # ë§¤ì¼ ì˜¤ì „ 7ì‹œ 50ë¶„ (KST)

  # ìˆ˜ë™ ì‹¤í–‰: Actions íƒ­ì—ì„œ "Run workflow" ë²„íŠ¼ìœ¼ë¡œ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# í™˜ê²½ ë³€ìˆ˜ (ëª¨ë“  jobsì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
env:
  PYTHON_VERSION: '3.11'
  TIMEZONE: 'Asia/Seoul'

jobs:
  monitor:
    name: Monitor Gomu News
    runs-on: ubuntu-latest

    # íƒ€ì„ì•„ì›ƒ ì„¤ì • (10ë¶„ ì´ˆê³¼ ì‹œ ìë™ ì¤‘ë‹¨)
    timeout-minutes: 10

    steps:
      # ========================================
      # Step 1: ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # ìµœì‹  ì»¤ë°‹ë§Œ ê°€ì ¸ì˜¤ê¸° (ì†ë„ í–¥ìƒ)

      # ========================================
      # Step 2: ì´ì „ ë°ì´í„°ë² ì´ìŠ¤ ë³µì› (ìºì‹œì—ì„œ)
      # ========================================
      - name: ğŸ”½ Restore previous database from cache
        id: cache-restore
        uses: actions/cache/restore@v3
        with:
          path: data/articles.db
          key: articles-db-${{ github.run_number }}
          restore-keys: |
            articles-db-

      # ========================================
      # Step 3: ë°ì´í„°ë² ì´ìŠ¤ ìƒíƒœ í™•ì¸
      # ========================================
      - name: ğŸ“Š Check database status
        run: |
          if [ -f data/articles.db ]; then
            echo "âœ… Previous database restored from cache"
            ls -lh data/articles.db
            db_size=$(du -h data/articles.db | cut -f1)
            echo "ğŸ“¦ DB size: $db_size"

            # SQLite ì„¤ì¹˜ ë° DB ë‚´ìš© í™•ì¸
            sudo apt-get update -qq
            sudo apt-get install -y sqlite3

            article_count=$(sqlite3 data/articles.db "SELECT COUNT(*) FROM articles;" 2>/dev/null || echo "0")
            notified_count=$(sqlite3 data/articles.db "SELECT COUNT(*) FROM articles WHERE notified = 1;" 2>/dev/null || echo "0")

            echo "ğŸ“š Total articles in DB: $article_count"
            echo "âœ‰ï¸  Notified articles: $notified_count"
            echo "ğŸ†• Pending notifications: $((article_count - notified_count))"
          else
            echo "â„¹ï¸  No previous database found (first run or cache miss)"
            mkdir -p data
            echo "ğŸ“ Created data directory"
          fi

      # ========================================
      # Step 4: Python í™˜ê²½ ì„¤ì •
      # ========================================
      - name: ğŸ Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # pip ìºì‹œ í™œì„±í™” (2íšŒì°¨ë¶€í„° ë¹ ë¥¸ ì„¤ì¹˜)

      # ========================================
      # Step 5: Chrome ë¸Œë¼ìš°ì € ë° ChromeDriver í™•ì¸
      # ========================================
      - name: ğŸŒ Setup Chrome and ChromeDriver
        run: |
          echo "ğŸ“¦ Checking Chrome and ChromeDriver..."

          # Ubuntu-latestì— ì´ë¯¸ Chromeê³¼ ChromeDriverê°€ ì„¤ì¹˜ë˜ì–´ ìˆìŒ
          chrome_version=$(google-chrome --version || echo "Chrome not found")
          chromedriver_version=$(chromedriver --version || echo "ChromeDriver not found")

          echo "Chrome: $chrome_version"
          echo "ChromeDriver: $chromedriver_version"

          # ChromeDriver ê²½ë¡œ í™•ì¸
          which chromedriver || echo "ChromeDriver not in PATH"

          echo "âœ… Browser setup complete"

      # ========================================
      # Step 6: Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
      # ========================================
      - name: ğŸ“¦ Install Python dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          pip install --upgrade pip
          pip install -r requirements.txt
          echo "âœ… Dependencies installed"

      # ========================================
      # Step 7: í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
      # ========================================
      - name: ğŸ” Create .env file from secrets
        run: |
          echo "ğŸ” Creating .env file..."
          cat << EOF > .env
          # Site Login
          LOGIN_EMAIL=${{ secrets.LOGIN_EMAIL }}
          LOGIN_PASSWORD=${{ secrets.LOGIN_PASSWORD }}

          # Email Notification
          EMAIL_FROM=${{ secrets.EMAIL_FROM }}
          EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
          EMAIL_TO=${{ secrets.EMAIL_TO }}

          # SMTP Configuration
          SMTP_SERVER=${{ secrets.SMTP_SERVER }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}

          # GitHub Actions Environment
          GITHUB_ACTIONS=true
          EOF

          echo "âœ… .env file created"

          # ë¹ˆ ê°’ ê²€ì¦ (ë³´ì•ˆ)
          if grep -q "=$" .env; then
            echo "âŒ Error: Some secrets are empty!"
            echo "Please check GitHub Secrets settings"
            exit 1
          fi

          echo "âœ… All secrets are set"

      # ========================================
      # Step 8: ë””ë ‰í† ë¦¬ ìƒì„±
      # ========================================
      - name: ğŸ“ Create required directories
        run: |
          mkdir -p data logs
          echo "âœ… Directories created"

      # ========================================
      # Step 9: ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
      # ========================================
      - name: ğŸ” Run monitoring
        id: monitor
        run: |
          echo "ğŸš€ Starting Gomu News Monitor..."
          echo "=============================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "=============================================="

          # Debug ëª¨ë“œ í™•ì¸
          if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
            echo "ğŸ› Debug mode enabled"
            export DEBUG=true
          fi

          # ëª¨ë‹ˆí„°ë§ ì‹¤í–‰
          python main.py --mode test

          echo "âœ… Monitoring completed"
        timeout-minutes: 8

      # ========================================
      # Step 10: ì—…ë°ì´íŠ¸ëœ ë°ì´í„°ë² ì´ìŠ¤ ìºì‹œ ì €ì¥
      # ========================================
      - name: ğŸ”¼ Save updated database to cache
        id: cache-save
        uses: actions/cache/save@v3
        if: always()  # ì„±ê³µ/ì‹¤íŒ¨ ë¬´ê´€í•˜ê²Œ í•­ìƒ ì €ì¥
        with:
          path: data/articles.db
          key: articles-db-${{ github.run_number }}

      # ========================================
      # Step 11: ë°ì´í„°ë² ì´ìŠ¤ í†µê³„ ì¶œë ¥
      # ========================================
      - name: ğŸ“Š Show database statistics
        if: always()
        run: |
          if [ -f data/articles.db ]; then
            echo "=========================================="
            echo "ğŸ“Š Final Database Statistics"
            echo "=========================================="

            # SQLiteê°€ ì´ë¯¸ Step 3ì—ì„œ ì„¤ì¹˜ë¨
            total=$(sqlite3 data/articles.db "SELECT COUNT(*) FROM articles;" 2>/dev/null || echo "0")
            notified=$(sqlite3 data/articles.db "SELECT COUNT(*) FROM articles WHERE notified = 1;" 2>/dev/null || echo "0")
            pending=$((total - notified))

            echo "ğŸ“š Total articles: $total"
            echo "âœ‰ï¸  Notified: $notified"
            echo "ğŸ†• Pending: $pending"

            # DB íŒŒì¼ í¬ê¸°
            db_size=$(du -h data/articles.db | cut -f1)
            echo "ğŸ’¾ Database size: $db_size"
            echo "=========================================="
          else
            echo "â„¹ï¸  No database file found"
          fi

      # ========================================
      # Step 12: ë¡œê·¸ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë§Œ)
      # ========================================
      - name: ğŸ“‹ Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: monitor-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7
          if-no-files-found: ignore

      # ========================================
      # Step 13: í†µê³„ ì¶œë ¥
      # ========================================
      - name: ğŸ“Š Show statistics
        if: always()
        run: |
          echo "=============================================="
          echo "ğŸ“Š Monitoring Statistics"
          echo "=============================================="
          python main.py --stats --days 1 || echo "No statistics available yet"

      # ========================================
      # Step 14: ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
      # ========================================
      - name: ğŸ“ Job Summary
        if: always()
        run: |
          echo "## ğŸ”” Gomu News Monitor" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**í•œêµ­ ì‹œê°„**: $(TZ=Asia/Seoul date '+%Y-%m-%d %H:%M:%S KST')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… **ìƒíƒœ**: ì„±ê³µ" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **ìƒíƒœ**: ì‹¤íŒ¨" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ’¡ **Tip**: ë¡œê·¸ë¥¼ í™•ì¸í•˜ë ¤ë©´ ìœ„ì˜ ê° stepì„ í´ë¦­í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY

# =============================================================================
# Workflow ì»¤ìŠ¤í„°ë§ˆì´ì§• ê°€ì´ë“œ
# =============================================================================
#
# 1. ì‹¤í–‰ ì£¼ê¸° ë³€ê²½:
#    schedule:
#      - cron: '50 22 * * *'   # ë§¤ì¼ 7:50 AM KST (í˜„ì¬ ì„¤ì •)
#      - cron: '0 * * * *'     # 1ì‹œê°„ë§ˆë‹¤
#      - cron: '0 */6 * * *'   # 6ì‹œê°„ë§ˆë‹¤
#      - cron: '0 9,21 * * *'  # ë§¤ì¼ 9ì‹œ, 21ì‹œ (UTC)
#
# 2. íƒ€ì„ì•„ì›ƒ ë³€ê²½:
#    timeout-minutes: 10   # ì „ì²´ job íƒ€ì„ì•„ì›ƒ
#    timeout-minutes: 8    # monitor step íƒ€ì„ì•„ì›ƒ
#
# 3. ë¡œê·¸ ë³´ê´€ ê¸°ê°„ ë³€ê²½:
#    retention-days: 7     # 7ì¼ â†’ ì›í•˜ëŠ” ì¼ìˆ˜ë¡œ ë³€ê²½
#
# 4. Cron ì‹œê°„ëŒ€ ë³€í™˜:
#    í•œêµ­(KST) = UTC + 9ì‹œê°„
#    UTC 0ì‹œ = í•œêµ­ ì˜¤ì „ 9ì‹œ
#    UTC 12ì‹œ = í•œêµ­ ì˜¤í›„ 9ì‹œ
#
#    Cron ë„êµ¬: https://crontab.guru/
#
# 5. ìºì‹œ ê´€ë ¨:
#    - GitHub Actions CacheëŠ” 7ì¼ê°„ ë¯¸ì‚¬ìš© ì‹œ ìë™ ì‚­ì œë¨
#    - ìºì‹œ í•œë„: Public repo 10GB, Private repo 10GB
#    - restore-keysë¥¼ í†µí•´ ì´ì „ ì‹¤í–‰ì˜ DBë¥¼ ìë™ìœ¼ë¡œ ë³µì›
#    - ì¤‘ë³µ ë©”ì¼ ë°©ì§€ë¥¼ ìœ„í•´ ìºì‹œ ì‚¬ìš© (artifacts ëŒ€ì‹ )
#
# =============================================================================
